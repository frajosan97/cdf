import{c as ue,r,j as e,a as O,H as pe,L as me}from"./app-BHvGR4js.js";import{B as q,y as p,A as he,D as B}from"./AuthenticatedLayout-BzUGl44w.js";import{u as te,S as Q}from"./sweetalert2.esm.all-CsTg8JN4.js";import{M as _,r as fe,u as xe}from"./xlsx-CRuIMA06.js";import{A as W}from"./Alert-CWilNkyM.js";import{T as se}from"./Table-OQRRGijP.js";import{F as H}from"./Form-Q2j9ICbV.js";import{B as X,C as be}from"./Container-p98MeQ5k.js";import{R as Z}from"./Row-C6NhzJ7b.js";import{C as G}from"./Col-DwigXgel.js";import{C as ee}from"./Card-pGXOtwt2.js";import"./ApplicationLogo-hP5aVGpV.js";import"./createLucideIcon-DHdMkeD_.js";import"./Nav-DifuSH0a.js";import"./Fade-C5nPZceD.js";import"./CloseButton-DQ3VpcOX.js";import"./warning-CjFOLJzl.js";import"./InputGroupContext-CBrQ1b5Q.js";const ge=({show:z,onHide:v,onSuccess:b,institutions:L})=>{const{wards:N=[],types:j=[],parent_statuses:E=[]}=ue().props.auth,[f,w]=r.useState(!1),[h,D]=r.useState(null),[J,A]=r.useState([]),[C,a]=r.useState(null),[n,s]=r.useState([]),[d,S]=r.useState(null),k=r.useRef(null),{showErrorToast:F}=te(),P=r.useMemo(()=>new Set(N.map(t=>t.name.toLowerCase().trim())),[N]),I=r.useMemo(()=>{const t=new Set;return N.forEach(o=>{o.locations?.forEach(i=>{t.add(i.name.toLowerCase().trim())})}),t},[N]),l=r.useMemo(()=>new Set(j.map(t=>t.toLowerCase())),[j]),ae=r.useMemo(()=>new Set(E.map(t=>t.toLowerCase())),[E]),K=["ward","location","institution","type","student_name","admission_number","parent_status","parent_phone","parent_id","amount"],U={ward:"Ward",location:"Location",institution:"Institution",type:"Type",student_name:"Student_Name",admission_number:"Admission",parent_status:"Parent_Status",parent_phone:"Parent_Phone",parent_id:"Parent_ID",amount:"Amount"},re=t=>{const o=K.filter(i=>!t.includes(i));return o.length>0?(a(`Missing required columns: ${o.map(i=>U[i]||i).join(", ")}`),!1):!0},ne=(t,o,i)=>{const u=[],m=c=>{const y=o.indexOf(c);return y!==-1?t[y]?.toString().trim():""};if(K.forEach(c=>{!m(c)&&c!=="amount"&&u.push({row:i+2,attribute:U[c]||c,errors:[`${U[c]||c} is required`],values:t})}),u.length>0)return u;const T=m("ward")?.toLowerCase().trim();T&&!P.has(T)&&u.push({row:i+2,attribute:"Ward",errors:[`Ward "${m("ward")}" does not exist in the system`],values:t});const M=m("location")?.toLowerCase().trim();M&&!I.has(M)&&u.push({row:i+2,attribute:"Location",errors:[`Location "${m("location")}" does not exist in the system`],values:t});const R=m("type")?.toLowerCase().trim();R&&!l.has(R)&&u.push({row:i+2,attribute:"Type",errors:[`Type must be one of: ${j.join(", ")}`],values:t});const x=m("parent_status")?.toLowerCase().trim();return x&&!ae.has(x)&&u.push({row:i+2,attribute:"Parent Status",errors:[`Parent status must be one of: ${E.join(", ")}`],values:t}),u},oe=t=>{const o=t.target.files[0];if(!o)return;a(null),s([]),S(null),D(o);const i=new FileReader;i.onload=u=>{try{const m=new Uint8Array(u.target.result),T=fe(m,{type:"array"}),M=T.SheetNames[0],R=T.Sheets[M],x=xe.sheet_to_json(R,{header:1,defval:""});if(x.length<2){a("File is empty or contains no data rows");return}const c=x[0].map(g=>String(g).toLowerCase().trim().replace(/\s+/g,"_"));if(!re(c))return;const y=[];for(let g=1;g<x.length;g++){const V=ne(x[g],c,g-1);y.push(...V)}y.length>0&&s(y);const le=x.slice(1,6).map(g=>{const V={};return c.forEach((ce,de)=>{V[ce]=g[de]||""}),V});A({headers:c,rows:le,totalRows:x.length-1})}catch(m){console.error("File parsing error:",m),a("Failed to parse file. Please check the file format.")}},i.readAsArrayBuffer(o)},ie=async()=>{if(!h){p.error("Please select a file to import");return}if(n.length>0){p.error("Please fix validation errors before importing");return}try{w(!0),a(null);const t=new FormData;t.append("file",h);const o=await O.post(route("import.applicants"),t,{headers:{"Content-Type":"multipart/form-data"}});o.data.success&&(S({imported:o.data.stats?.imported||0,skipped:o.data.stats?.skipped||0}),o.data.stats?.failures&&o.data.stats.failures.length>0?(s(o.data.stats.failures),p.warning("Import completed with some errors")):(p.success(o.data.message),setTimeout(()=>{b(),Y()},2e3)))}catch(t){t.response?.data?.errors?(s(t.response.data.errors),p.error("Validation errors found in the file")):t.response?.data?.message?(a(t.response.data.message),p.error(t.response.data.message)):F(t,"Failed to import file")}finally{w(!1)}},Y=()=>{D(null),A([]),a(null),s([]),S(null),k.current&&(k.current.value=""),v()};return e.jsxs(_,{show:z,onHide:Y,size:"lg",backdrop:"static",keyboard:!1,centered:!0,children:[e.jsx(_.Header,{closeButton:!0,className:"bg-light",children:e.jsxs(_.Title,{className:"h5 mb-0",children:[e.jsx("i",{className:"bi bi-file-earmark-excel me-2"}),"Bulk Import Applicants"]})}),e.jsxs(_.Body,{className:"py-4",children:[C&&e.jsxs(W,{variant:"danger",dismissible:!0,onClose:()=>a(null),className:"mb-3",children:[e.jsx("i",{className:"bi bi-exclamation-triangle-fill me-2"}),C]}),d&&e.jsx(W,{variant:"success",className:"mb-3",children:e.jsxs("div",{className:"d-flex align-items-center",children:[e.jsx("i",{className:"bi bi-check-circle-fill text-success me-3 fs-4"}),e.jsxs("div",{children:[e.jsx("h6",{className:"alert-heading fw-bold mb-1",children:"Import Summary"}),e.jsxs("p",{className:"mb-0",children:["Successfully imported:"," ",e.jsx(q,{bg:"success",className:"ms-1",children:d.imported}),e.jsx("br",{}),"Skipped rows:"," ",e.jsx(q,{bg:"warning",className:"ms-1",children:d.skipped})]})]})]})}),n.length>0&&e.jsxs(W,{variant:"warning",className:"mb-3",children:[e.jsxs("h6",{className:"alert-heading fw-bold",children:[e.jsx("i",{className:"bi bi-exclamation-triangle-fill me-2"}),"Validation Errors (",n.length,")"]}),e.jsx("div",{style:{maxHeight:"300px",overflowY:"auto"},children:e.jsxs(se,{size:"sm",bordered:!0,className:"mb-0",children:[e.jsx("thead",{className:"table-light",children:e.jsxs("tr",{children:[e.jsx("th",{children:"Row"}),e.jsx("th",{children:"Field"}),e.jsx("th",{children:"Errors"})]})}),e.jsx("tbody",{children:n.map((t,o)=>e.jsxs("tr",{children:[e.jsx("td",{children:t.row}),e.jsx("td",{children:e.jsx(q,{bg:"secondary",children:t.attribute})}),e.jsx("td",{children:e.jsx("ul",{className:"mb-0 ps-3",children:t.errors.map((i,u)=>e.jsx("li",{className:"small text-danger",children:i},u))})})]},o))})]})})]}),e.jsxs(H.Group,{className:"mb-4",children:[e.jsx(H.Label,{className:"fw-semibold",children:"Select Excel/CSV File"}),e.jsx(H.Control,{type:"file",ref:k,accept:".xlsx,.xls,.csv",onChange:oe,disabled:f}),e.jsx(H.Text,{className:"text-muted",children:"Supported formats: .xlsx, .xls, .csv (Max size: 10MB)"})]})]}),e.jsxs(_.Footer,{className:"bg-light",children:[e.jsxs(X,{variant:"secondary",onClick:Y,disabled:f,children:[e.jsx("i",{className:"bi bi-x-circle me-2"}),"Cancel"]}),e.jsx(X,{variant:"primary",onClick:ie,disabled:!h||f||n.length>0,children:f?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"spinner-border spinner-border-sm me-2",role:"status","aria-hidden":"true"}),"Importing..."]}):e.jsxs(e.Fragment,{children:[e.jsx("i",{className:"bi bi-upload me-2"}),"Import Data"]})})]})]})},Me=({institutions:z})=>{const v=r.useRef(null),b=r.useRef(null),L=r.useRef(!1),[N,j]=r.useState(!1),[E,f]=r.useState(!1),{showErrorToast:w}=te(),h=r.useCallback(()=>{b.current&&b.current.ajax.reload(null,!1)},[]),D=r.useCallback(a=>{a?.stopPropagation(),j(!0)},[]),J=r.useCallback(()=>{h(),j(!1),p.success("Bulk import completed successfully")},[h]),A=r.useCallback(async a=>{try{if(!(await Q.fire({title:"Are you sure?",text:"You won't be able to revert this!",icon:"warning",showCancelButton:!0,confirmButtonColor:"#d33",cancelButtonColor:"#3085d6",confirmButtonText:"Yes, delete it!",cancelButtonText:"Cancel"})).isConfirmed)return;f(!0);const s=await O.delete(route("applicant.destroy",a));s.data?.success?(p.success("Applicant deleted successfully"),h()):p.error(s.data?.message||"Failed to delete applicant")}catch(n){w(n,"Failed to delete applicant")}finally{f(!1)}},[h,w]),C=r.useCallback(async(a,n)=>{try{const{value:s}=await Q.fire({title:`${n.charAt(0).toUpperCase()+n.slice(1)} Applicant`,text:`Are you sure you want to ${n} this applicant?`,input:"textarea",inputLabel:"Reason (optional)",inputPlaceholder:"Enter reason for decision...",inputAttributes:{"aria-label":"Enter reason for decision"},showCancelButton:!0,confirmButtonColor:n==="approved"?"#28a745":"#dc3545",cancelButtonColor:"#6c757d",confirmButtonText:`Yes, ${n}`,cancelButtonText:"Cancel"});if(s===void 0)return;f(!0);const d=await O.post(route("applicant.decision",a),{decision:n,decision_reason:s||null});d.data?.success?(p.success(`Applicant ${n} successfully`),h()):p.error(d.data?.message||"Failed to update decision")}catch(s){w(s,"Failed to update decision")}finally{f(!1)}},[h,w]);return r.useEffect(()=>{if(!(!v.current||L.current))return b.current=$(v.current).DataTable({processing:!0,serverSide:!0,ajax:{url:route("applicant.index"),type:"GET",error:(a,n,s)=>{console.error("DataTable error:",s),p.error("Failed to load applicants data")}},columns:[{data:"student_name",name:"student_name",title:"Name"},{data:"admission_number",name:"admission_number",title:"Admission"},{data:"institution",name:"institution",title:"Institution"},{data:"type",name:"type",title:"Type",className:"text-uppercase"},{data:"amount",name:"amount",title:"Amount"},{data:"decision",name:"decision",title:"Status",render:a=>!a||a==="pending"?'<span class="badge bg-warning">Pending</span>':`<span class="badge ${{approved:"bg-success",rejected:"bg-danger"}[a]||"bg-secondary"}">${a.charAt(0).toUpperCase()+a.slice(1)}</span>`},{data:"actions",name:"actions",title:"Actions",orderable:!1,searchable:!1}],language:{processing:"Loading applicants...",emptyTable:"<div class='text-center py-5'><i class='bi bi-people fs-1'></i><br>No data available</div>",zeroRecords:"<div class='text-center py-5'><i class='bi bi-people fs-1'></i><br>No matching records found</div>"},pageLength:10,responsive:!0,destroy:!0}),L.current=!0,()=>{b.current&&(b.current.destroy(),b.current=null,L.current=!1)}},[]),r.useEffect(()=>{const a=v.current;if(!a)return;const n=s=>{const d=$(s.target),S=d.closest(".view-btn");if(S.length){s.preventDefault(),s.stopPropagation();const l=S.data("id");l&&(window.location.href=route("applicant.show",l));return}const k=d.closest(".edit-btn");if(k.length){s.preventDefault(),s.stopPropagation();const l=k.data("id");l&&(window.location.href=route("applicant.edit",l));return}const F=d.closest(".delete-btn");if(F.length){s.preventDefault(),s.stopPropagation();const l=F.data("id");l&&A(l);return}const P=d.closest(".approve-btn");if(P.length){s.preventDefault(),s.stopPropagation();const l=P.data("id");l&&C(l,"approved");return}const I=d.closest(".reject-btn");if(I.length){s.preventDefault(),s.stopPropagation();const l=I.data("id");l&&C(l,"rejected")}};return a.addEventListener("click",n),()=>{a.removeEventListener("click",n)}},[A,C]),e.jsxs(he,{children:[e.jsx(pe,{title:"Applicants"}),e.jsxs(be,{fluid:!0,children:[e.jsxs(Z,{className:"mb-4 align-items-center",children:[e.jsxs(G,{children:[e.jsx("h1",{className:"h2 mb-0 fw-bold",children:"Applicants Management"}),e.jsx("p",{className:"text-muted mt-1 mb-0",children:"Manage and process scholarship applicants"})]}),e.jsx(G,{xs:"auto",children:e.jsxs("div",{className:"d-flex gap-2",children:[e.jsxs(me,{href:route("applicant.create"),className:"btn btn-primary",children:[e.jsx("i",{className:"bi bi-plus-circle me-2"}),"Add Applicant"]}),e.jsxs(B,{align:"end",children:[e.jsxs(B.Toggle,{variant:"outline-primary",id:"dropdown-actions",disabled:E,children:[e.jsx("i",{className:"bi bi-file-earmark-excel me-2"}),"Import/Export"]}),e.jsxs(B.Menu,{children:[e.jsxs(B.Item,{onClick:D,className:"d-flex align-items-center gap-2",children:[e.jsx("i",{className:"bi bi-upload"}),e.jsx("span",{children:"Bulk Import (Excel)"})]}),e.jsxs(B.Item,{href:route("template.applicants"),className:"d-flex align-items-center gap-2",children:[e.jsx("i",{className:"bi bi-download"}),e.jsx("span",{children:"Download Template"})]}),e.jsxs(B.Item,{href:route("export.applicants"),className:"d-flex align-items-center gap-2",children:[e.jsx("i",{className:"bi bi-file-earmark-excel"}),e.jsx("span",{children:"Export All"})]})]})]})]})})]}),e.jsx(Z,{children:e.jsx(G,{children:e.jsx(ee,{className:"rounded-3 border-0 shadow-sm",children:e.jsx(ee.Body,{children:e.jsx(se,{ref:v,responsive:!0,bordered:!0,striped:!0,hover:!0,className:"align-middle"})})})})})]}),e.jsx(ge,{show:N,onHide:()=>j(!1),onSuccess:J,institutions:z})]})};export{Me as default};
