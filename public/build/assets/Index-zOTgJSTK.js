import{j as e,r as a,a as V,H as le}from"./app-BDdR8tlL.js";import{B as H,y as h,A as oe,D as M}from"./AuthenticatedLayout-C3TfAMOg.js";import{u as ae,S as ee}from"./sweetalert2.esm.all-7-SMlaii.js";import{F as c}from"./Form-CkKKQG-5.js";import{M as k,r as ce,u as de}from"./xlsx-NKFBRnVC.js";import{R as G,C as _,a as te}from"./Row-8B2WQNFF.js";import{B as O,C as ue}from"./ApplicationLogo-Ct94hGqC.js";import{A as X}from"./Alert-D2NsIJyT.js";import{T as Z}from"./Table-mAUZDb-t.js";import"./createLucideIcon-D8spSUSA.js";import"./CloseButton-ByA966yN.js";import"./warning-Dkzfv9EX.js";import"./InputGroupContext-B2VXgMWZ.js";const me=({selectedValue:N,onChange:p,disabled:S=!1})=>{const b=[{value:"secondary",label:"Secondary School"},{value:"polytechnic",label:"Polytechnic"},{value:"college",label:"College"},{value:"university",label:"University"}];return e.jsxs(c.Select,{name:"category",value:N,onChange:p,disabled:S,"aria-label":"Select institution category",children:[e.jsx("option",{value:"",children:"Select Category"}),b.map(g=>e.jsx("option",{value:g.value,children:g.label},g.value))]})},he=({show:N,onHide:p,onSubmit:S,formData:b,setFormData:g,isEdit:y=!1,loading:x=!1})=>{const n=E=>{const{name:T,value:f,type:d,checked:u}=E.target;g(o=>({...o,[T]:d==="checkbox"?u:f}))};return e.jsxs(k,{show:N,onHide:p,size:"lg",backdrop:"static",keyboard:!1,centered:!0,children:[e.jsx(k.Header,{closeButton:!0,className:"bg-light",children:e.jsxs(k.Title,{className:"h5 mb-0",children:[e.jsx("i",{className:`bi ${y?"bi-pencil-square":"bi-plus-circle"} me-2`}),y?"Edit Institution":"Add New Institution"]})}),e.jsxs(c,{onSubmit:S,children:[e.jsxs(k.Body,{className:"py-4",children:[e.jsxs(G,{children:[e.jsx(_,{md:6,children:e.jsxs(c.Group,{className:"mb-3",children:[e.jsxs(c.Label,{className:"fw-semibold",children:["Name ",e.jsx("span",{className:"text-danger",children:"*"})]}),e.jsx(c.Control,{type:"text",name:"name",value:b.name,onChange:n,required:!0,placeholder:"Enter institution name",disabled:x,autoFocus:!0})]})}),e.jsx(_,{md:6,children:e.jsxs(c.Group,{className:"mb-3",children:[e.jsx(c.Label,{className:"fw-semibold",children:"Category"}),e.jsx(me,{selectedValue:b.category,onChange:n,disabled:x}),e.jsx(c.Text,{className:"text-muted",children:"Select the type of institution"})]})})]}),e.jsx(G,{children:e.jsx(_,{md:6,children:e.jsxs(c.Group,{className:"mb-3",children:[e.jsx(c.Check,{type:"switch",id:"is_active_switch",label:"Active Status",name:"is_active",checked:b.is_active,onChange:n,disabled:x}),e.jsx(c.Text,{className:"text-muted d-block",children:"Toggle to activate/deactivate this institution"})]})})})]}),e.jsxs(k.Footer,{className:"bg-light",children:[e.jsxs(O,{variant:"secondary",onClick:p,disabled:x,children:[e.jsx("i",{className:"bi bi-x-circle me-2"}),"Cancel"]}),e.jsx(O,{variant:"primary",type:"submit",disabled:x,children:x?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"spinner-border spinner-border-sm me-2",role:"status","aria-hidden":"true"}),y?"Updating...":"Creating..."]}):e.jsxs(e.Fragment,{children:[e.jsx("i",{className:`bi ${y?"bi-check-circle":"bi-plus-circle"} me-2`}),y?"Update":"Create"]})})]})]})]})},pe=({show:N,onHide:p,onSuccess:S})=>{const[b,g]=a.useState(!1),[y,x]=a.useState(null),[n,E]=a.useState([]),[T,f]=a.useState(null),[d,u]=a.useState([]),[o,A]=a.useState(null),w=a.useRef(null),{showErrorToast:L}=ae(),P=a.useMemo(()=>["secondary","polytechnic","college","university","special"],[]),I=["name","category"],B={name:"Name",category:"Category"},Y=t=>{const s=I.filter(r=>!t.includes(r));return s.length>0?(f(`Missing required columns: ${s.map(r=>B[r]||r).join(", ")}`),!1):!0},J=(t,s,r)=>{const l=[],j=v=>{const C=s.indexOf(v);return C!==-1?t[C]?.toString().trim():""};if(I.forEach(v=>{j(v)||l.push({row:r+2,attribute:B[v]||v,errors:[`${B[v]||v} is required`],values:t})}),l.length>0)return l;const m=j("name");m.length<2&&l.push({row:r+2,attribute:"Name",errors:["Institution name must be at least 2 characters"],values:t}),m.length>255&&l.push({row:r+2,attribute:"Name",errors:["Institution name must not exceed 255 characters"],values:t});const D=j("category")?.toLowerCase().trim();return D&&!P.includes(D)&&l.push({row:r+2,attribute:"Category",errors:[`Category must be one of: ${P.join(", ")}`],values:t}),l},K=t=>{const s=t.target.files[0];if(!s)return;f(null),u([]),A(null),x(s);const r=new FileReader;r.onload=l=>{try{const j=new Uint8Array(l.target.result),m=ce(j,{type:"array"}),D=m.SheetNames[0],v=m.Sheets[D],C=de.sheet_to_json(v,{header:1,defval:""});if(C.length<2){f("File is empty or contains no data rows");return}const z=C[0].map(F=>String(F).toLowerCase().trim().replace(/\s+/g,"_"));if(!Y(z))return;const W=[];for(let F=1;F<C.length;F++){const U=J(C[F],z,F-1);W.push(...U)}W.length>0&&u(W);const re=C.slice(1,6).map(F=>{const U={};return z.forEach((ie,ne)=>{U[ie]=F[ne]||""}),U});E({headers:z,rows:re,totalRows:C.length-1})}catch(j){console.error("File parsing error:",j),f("Failed to parse file. Please check the file format.")}},r.readAsArrayBuffer(s)},q=async()=>{if(!y){h.error("Please select a file to import");return}if(d.length>0){h.error("Please fix validation errors before importing");return}try{g(!0),f(null);const t=new FormData;t.append("file",y);const s=await V.post(route("import.institutions"),t,{headers:{"Content-Type":"multipart/form-data"}});s.data.success&&(A({imported:s.data.stats?.imported||0,skipped:s.data.stats?.skipped||0}),s.data.stats?.failures&&s.data.stats.failures.length>0?(u(s.data.stats.failures),h.warning("Import completed with some errors")):(h.success(s.data.message),setTimeout(()=>{S(),R()},2e3)))}catch(t){t.response?.data?.errors?(u(t.response.data.errors),h.error("Validation errors found in the file")):t.response?.data?.message?(f(t.response.data.message),h.error(t.response.data.message)):L(t,"Failed to import file")}finally{g(!1)}},R=()=>{x(null),E([]),f(null),u([]),A(null),w.current&&(w.current.value=""),p()},Q=t=>d.filter(s=>s.row===t+2).length,i=(t,s)=>d.filter(r=>r.row===t+2&&r.attribute.toLowerCase()===s.toLowerCase());return e.jsxs(k,{show:N,onHide:R,size:"lg",backdrop:"static",keyboard:!1,centered:!0,children:[e.jsx(k.Header,{closeButton:!0,className:"bg-light",children:e.jsxs(k.Title,{className:"h5 mb-0",children:[e.jsx("i",{className:"bi bi-file-earmark-excel me-2"}),"Bulk Import Institutions"]})}),e.jsxs(k.Body,{className:"py-4",children:[T&&e.jsxs(X,{variant:"danger",dismissible:!0,onClose:()=>f(null),className:"mb-3",children:[e.jsx("i",{className:"bi bi-exclamation-triangle-fill me-2"}),T]}),o&&e.jsx(X,{variant:"success",className:"mb-3",children:e.jsxs("div",{className:"d-flex align-items-center",children:[e.jsx("i",{className:"bi bi-check-circle-fill text-success me-3 fs-4"}),e.jsxs("div",{children:[e.jsx("h6",{className:"alert-heading fw-bold mb-1",children:"Import Summary"}),e.jsxs("p",{className:"mb-0",children:["Successfully imported:"," ",e.jsx(H,{bg:"success",className:"ms-1",children:o.imported}),e.jsx("br",{}),"Skipped rows:"," ",e.jsx(H,{bg:"warning",className:"ms-1",children:o.skipped})]})]})]})}),d.length>0&&e.jsxs(X,{variant:"warning",className:"mb-3",children:[e.jsxs("h6",{className:"alert-heading fw-bold",children:[e.jsx("i",{className:"bi bi-exclamation-triangle-fill me-2"}),"Validation Errors (",d.length,")"]}),e.jsx("div",{style:{maxHeight:"300px",overflowY:"auto"},children:e.jsxs(Z,{size:"sm",bordered:!0,className:"mb-0",children:[e.jsx("thead",{className:"table-light",children:e.jsxs("tr",{children:[e.jsx("th",{children:"Row"}),e.jsx("th",{children:"Field"}),e.jsx("th",{children:"Errors"})]})}),e.jsx("tbody",{children:d.map((t,s)=>e.jsxs("tr",{children:[e.jsx("td",{children:t.row}),e.jsx("td",{children:e.jsx(H,{bg:"secondary",children:t.attribute})}),e.jsx("td",{children:e.jsx("ul",{className:"mb-0 ps-3",children:t.errors.map((r,l)=>e.jsx("li",{className:"small text-danger",children:r},l))})})]},s))})]})})]}),e.jsxs(c.Group,{className:"mb-4",children:[e.jsx(c.Label,{className:"fw-semibold",children:"Select Excel/CSV File"}),e.jsx(c.Control,{type:"file",ref:w,accept:".xlsx,.xls,.csv",onChange:K,disabled:b}),e.jsx(c.Text,{className:"text-muted",children:"Supported formats: .xlsx, .xls, .csv (Max size: 10MB)"})]}),n.rows&&n.rows.length>0&&e.jsxs("div",{className:"mt-4",children:[e.jsxs("h6",{className:"fw-bold mb-3 d-flex align-items-center",children:[e.jsx("i",{className:"bi bi-eye me-2"}),"Preview (First 5 rows of ",n.totalRows," ","total):"]}),e.jsx("div",{className:"table-responsive",children:e.jsxs(Z,{striped:!0,bordered:!0,size:"sm",hover:!0,children:[e.jsx("thead",{className:"bg-light",children:e.jsxs("tr",{children:[n.headers.map((t,s)=>e.jsx("th",{children:B[t]||t.charAt(0).toUpperCase()+t.slice(1)},s)),d.length>0&&e.jsx("th",{children:"Status"})]})}),e.jsx("tbody",{children:n.rows.map((t,s)=>{const r=Q(s);return e.jsxs("tr",{children:[n.headers.map((l,j)=>{const m=i(s,l),D=m.length>0;return e.jsxs("td",{className:D?"bg-danger bg-opacity-10":"",children:[t[l]||"-",D&&e.jsx("i",{className:"bi bi-exclamation-triangle-fill text-danger ms-2",title:m.map(v=>v.errors.join(", ")).join("; ")})]},j)}),d.length>0&&e.jsx("td",{children:r>0?e.jsxs(H,{bg:"warning",text:"dark",children:[r," ","error",r>1?"s":""]}):e.jsx(H,{bg:"success",children:"Valid"})})]},s)})})]})})]})]}),e.jsxs(k.Footer,{className:"bg-light",children:[e.jsxs(O,{variant:"secondary",onClick:R,disabled:b,children:[e.jsx("i",{className:"bi bi-x-circle me-2"}),"Cancel"]}),e.jsx(O,{variant:"primary",onClick:q,disabled:!y||b||d.length>0,children:b?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"spinner-border spinner-border-sm me-2",role:"status","aria-hidden":"true"}),"Importing..."]}):e.jsxs(e.Fragment,{children:[e.jsx("i",{className:"bi bi-upload me-2"}),"Import Data"]})})]})]})},se={name:"",category:"",is_active:!0},Be=()=>{const N=a.useRef(null),p=a.useRef(null),S=a.useRef(!1),[b,g]=a.useState(!1),[y,x]=a.useState(!1),[n,E]=a.useState(!1),[T,f]=a.useState(null),[d,u]=a.useState(!1),[o,A]=a.useState(se),{showErrorToast:w}=ae(),L=a.useCallback(()=>{A(se),f(null),E(!1)},[]),P=a.useCallback(()=>o.name?.trim()?o.category?.trim()?!0:(h.error("Category is required"),!1):(h.error("Institution name is required"),!1),[o.name,o.category]),I=a.useCallback(()=>{p.current&&p.current.ajax.reload(null,!1)},[]),B=a.useCallback(()=>{g(!1),L()},[L]),Y=a.useCallback(i=>{i?.stopPropagation(),L(),g(!0)},[L]),J=a.useCallback(i=>{i?.stopPropagation(),x(!0)},[]),K=a.useCallback(()=>{I(),x(!1),h.success("Bulk import completed successfully")},[I]),q=a.useCallback(async i=>{try{u(!0);const t=await V.get(route("institution.show",i));if(t.data?.institution){const s=t.data.institution;f(s),A({name:s.name||"",category:s.category||"",is_active:s.is_active??!0}),E(!0),g(!0)}}catch(t){w(t,"Failed to load institution")}finally{u(!1)}},[w]),R=a.useCallback(async i=>{try{if(!(await ee.fire({title:"Are you sure?",text:"You won't be able to revert this!",icon:"warning",showCancelButton:!0,confirmButtonColor:"#d33",cancelButtonColor:"#3085d6",confirmButtonText:"Yes, delete it!",cancelButtonText:"Cancel"})).isConfirmed)return;u(!0);const s=await V.delete(route("institution.destroy",i));s.data?.success?(h.success("Institution deleted successfully"),I()):h.error(s.data?.message||"Failed to delete institution")}catch(t){w(t,"Failed to delete institution")}finally{u(!1)}},[I,w]),Q=a.useCallback(async i=>{if(i.preventDefault(),i.stopPropagation(),!!P())try{if(!(await ee.fire({title:n?"Update Institution":"Create Institution",text:n?"Are you sure you want to update this institution?":"Are you sure you want to create this institution?",icon:"question",showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:"Yes",cancelButtonText:"Cancel"})).isConfirmed)return;u(!0);const s=n?route("institution.update",T.id):route("institution.store"),r=await V({method:n?"put":"post",url:s,data:{name:o.name.trim(),category:o.category.trim(),is_active:o.is_active}});r.data?.success?(h.success(n?"Institution updated successfully":"Institution created successfully"),B(),I()):h.error(r.data?.message||"Operation failed")}catch(t){w(t)}finally{u(!1)}},[o,n,T,P,I,w,B]);return a.useEffect(()=>{if(!(!N.current||S.current))return p.current=$(N.current).DataTable({processing:!0,serverSide:!0,ajax:{url:route("institution.index"),type:"GET",error:(i,t,s)=>{console.error("DataTable error:",s),h.error("Failed to load institutions data")}},columns:[{data:"name",name:"name",title:"Name"},{data:"category",name:"category",title:"Category",render:i=>i?i.charAt(0).toUpperCase()+i.slice(1).toLowerCase():"-"},{data:"is_active",name:"is_active",title:"Status",render:i=>i?'<span class="badge bg-success">Active</span>':'<span class="badge bg-danger">Inactive</span>'},{data:"actions",name:"actions",title:"Actions",orderable:!1,searchable:!1}],language:{processing:"Loading institutions...",emptyTable:"<div class='text-center py-5'><i class='bi bi-building fs-1'></i><br>No data available</div>",zeroRecords:"<div class='text-center py-5'><i class='bi bi-building fs-1'></i><br>No matching records found</div>"},pageLength:10,responsive:!0,destroy:!0}),S.current=!0,()=>{p.current&&(p.current.destroy(),p.current=null,S.current=!1)}},[]),a.useEffect(()=>{const i=N.current;if(!i)return;const t=s=>{const r=$(s.target),l=r.closest(".edit-btn");if(l.length){s.preventDefault(),s.stopPropagation();const m=l.data("id");m&&q(m);return}const j=r.closest(".delete-btn");if(j.length){s.preventDefault(),s.stopPropagation();const m=j.data("id");m&&R(m)}};return i.addEventListener("click",t),()=>{i.removeEventListener("click",t)}},[q,R]),e.jsxs(oe,{children:[e.jsx(le,{title:"Institutions"}),e.jsxs(ue,{fluid:!0,children:[e.jsxs(G,{className:"mb-4 align-items-center",children:[e.jsxs(_,{children:[e.jsx("h1",{className:"h2 mb-0 fw-bold",children:"Institutions Management"}),e.jsx("p",{className:"text-muted mt-1 mb-0",children:"Manage and organize your educational institutions"})]}),e.jsx(_,{xs:"auto",children:e.jsx("div",{className:"d-flex gap-2",children:e.jsxs(M,{align:"end",children:[e.jsxs(M.Toggle,{variant:"primary",id:"dropdown-actions",disabled:d,children:[e.jsx("i",{className:"bi bi-plus-circle me-2"}),"Add Institution"]}),e.jsxs(M.Menu,{children:[e.jsxs(M.Item,{onClick:Y,className:"d-flex align-items-center gap-2",children:[e.jsx("i",{className:"bi bi-plus-circle"}),e.jsx("span",{children:"Single Institution"})]}),e.jsxs(M.Item,{onClick:J,className:"d-flex align-items-center gap-2",children:[e.jsx("i",{className:"bi bi-file-earmark-excel"}),e.jsx("span",{children:"Bulk Import (Excel)"})]}),e.jsxs(M.Item,{href:route("template.institutions"),className:"d-flex align-items-center gap-2",children:[e.jsx("i",{className:"bi bi-download"}),e.jsx("span",{children:"Download Template"})]}),e.jsxs(M.Item,{href:route("export.institutions"),className:"d-flex align-items-center gap-2",children:[e.jsx("i",{className:"bi bi-file-earmark-excel"}),e.jsx("span",{children:"Export All"})]})]})]})})})]}),e.jsx(G,{children:e.jsx(_,{children:e.jsx(te,{className:"rounded-3 border-0 shadow-sm",children:e.jsx(te.Body,{children:e.jsx(Z,{ref:N,responsive:!0,bordered:!0,striped:!0,hover:!0,className:"align-middle"})})})})})]}),e.jsx(he,{show:b,onHide:B,onSubmit:Q,formData:o,setFormData:A,isEdit:n,loading:d}),e.jsx(pe,{show:y,onHide:()=>x(!1),onSuccess:K})]})};export{Be as default};
